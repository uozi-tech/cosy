import{S as ie}from"./SessionLogsDisplay-nu0O8H-k.js";import{z as Q,S as X,A as re,E as de,F as ce,H as _e,w as pe,J as me,y as fe,x as ve,o as Y,f as ge,j as ye,G as J,r as we,s as qe,t as ke,u as he,q as Te,R as be,K as xe,N as Se,v as Ae,p as Ce,O as K}from"./ant-design-vue-BZxoqjSI.js";import{d as Z,f as g,c as B,w as ee,U as I,V as _,W as s,X as v,k as t,Y as L,a4 as h,u as l,H as T,G as n,F as Re,Z as De,$ as c,r as Ie,o as Le,b as $e,a3 as Pe}from"./vue-vendor-PlmX_NZX.js";import{_ as te,u as Ee}from"./index-BG6BHNhw.js";import{_ as Me}from"./ControlsWrapper.vue_vue_type_script_setup_true_lang-C68JYIS5.js";import{R as Oe}from"./RequestDetailModal-WuXQgFmw.js";import{b as Ue,e as ze,d as Be,l as Ge,g as Ne,i as j}from"./useApi-C9wvGAhc.js";const He={class:"batch-logs-container"},Ve={key:0,class:"sort-control"},Fe={key:1,class:"no-logs"},Ke={key:2,class:"session-groups"},We={class:"session-header"},Je={class:"url-text"},je={class:"time-text"},Qe={class:"session-content"},Xe={class:"request-info"},Ye=Z({__name:"BatchRequestLogsModal",setup(se,{expose:G}){const w=g(!1),b=g([]),x=g([]),p=g("newer"),m=B(()=>b.value.map(a=>({title:`${a.req_method} ${a.req_url} (${a.latency})`,method:a.req_method,url:a.req_url,latency:a.latency,sessionLogs:a.session_logs,requestTrace:a})).filter(a=>a.sessionLogs&&a.sessionLogs.trim()!==""&&a.sessionLogs!=="[]").sort((a,r)=>{const C=a.requestTrace.start_time,k=r.requestTrace.start_time;return p.value==="newer"?k-C:C-k}));function S(i){b.value=i,w.value=!0}function E(){w.value=!1,b.value=[]}function A(i){return{GET:"blue",POST:"green",PUT:"orange",DELETE:"red",PATCH:"purple",OPTIONS:"cyan"}[i]||"default"}return ee(w,i=>{i&&m.value.length>0&&(x.value=m.value.map((a,r)=>r))}),G({open:S,close:E}),(i,a)=>{const r=Q,C=de,k=re,N=X,$=ce,O=Y,R=ve,U=fe,H=me,V=_e,F=pe;return _(),I(F,{open:l(w),"onUpdate:open":a[2]||(a[2]=u=>T(w)?w.value=u:null),width:"90%",centered:"",footer:null,title:"批量请求日志查看",class:"batch-request-modal"},{default:s(()=>[v("div",He,[t(r,{message:`总计: ${l(b).length} 条记录，包含会话日志: ${l(m).length} 条记录`,type:"info","show-icon":"",class:"info-alert"},null,8,["message"]),l(m).length>1?(_(),L("div",Ve,[t(N,null,{default:s(()=>[a[5]||(a[5]=v("span",{class:"sort-label"},"排序顺序:",-1)),t(k,{value:l(p),"onUpdate:value":a[0]||(a[0]=u=>T(p)?p.value=u:null),"button-style":"solid",size:"small"},{default:s(()=>[t(C,{value:"newer"},{default:s(()=>[...a[3]||(a[3]=[n(" 新的在前 ",-1)])]),_:1}),t(C,{value:"older"},{default:s(()=>[...a[4]||(a[4]=[n(" 旧的在前 ",-1)])]),_:1})]),_:1},8,["value"])]),_:1})])):h("",!0),l(m).length===0?(_(),L("div",Fe,[t($,{description:"选中的记录中没有可用的会话日志"})])):(_(),L("div",Ke,[t(V,{"active-key":l(x),"onUpdate:activeKey":a[1]||(a[1]=u=>T(x)?x.value=u:null),accordion:!1,class:"session-collapse"},{default:s(()=>[(_(!0),L(Re,null,De(l(m),(u,o)=>(_(),I(H,{key:o,class:"session-panel"},{header:s(()=>[v("div",We,[t(O,{color:A(u.method),class:"method-tag"},{default:s(()=>[n(c(u.method),1)]),_:2},1032,["color"]),v("span",Je,c(u.url),1),t(O,{color:"processing",class:"latency-tag"},{default:s(()=>[n(c(u.latency),1)]),_:2},1024),v("span",je,c(new Date(u.requestTrace.start_time*1e3).toLocaleString()),1)])]),default:s(()=>[v("div",Qe,[v("div",Xe,[t(U,{size:"small",column:4,bordered:""},{default:s(()=>[t(R,{label:"请求时间"},{default:s(()=>[n(c(new Date(u.requestTrace.start_time*1e3).toLocaleString()),1)]),_:2},1024),t(R,{label:"请求ID"},{default:s(()=>[n(c(u.requestTrace.request_id),1)]),_:2},1024),t(R,{label:"状态码"},{default:s(()=>[n(c(u.requestTrace.resp_status_code),1)]),_:2},1024),t(R,{label:"客户端IP"},{default:s(()=>[n(c(u.requestTrace.ip),1)]),_:2},1024),u.requestTrace.user_agent?(_(),I(R,{key:0,label:"User Agent",span:4},{default:s(()=>[n(c(u.requestTrace.user_agent),1)]),_:2},1024)):h("",!0)]),_:2},1024)]),t(ie,{"session-logs":u.sessionLogs,"show-title":!1},null,8,["session-logs"])])]),_:2},1024))),128))]),_:1},8,["active-key"])]))])]),_:1},8,["open"])}}}),Ze=te(Ye,[["__scopeId","data-v-68130e3e"]]),et={class:"requests-page"},tt={class:"mb-6"},st={key:0,class:"mb-4"},at={class:"font-mono text-sm"},ot={key:3,class:"font-mono text-xs"},lt={class:"py-8 text-center"},nt=Z({__name:"Requests",setup(se){const G=Ee(),{data:w,loading:b,execute:x}=Ue(),p=g(""),m=g(),S=g(),E=g(),A=g(!1),i=g([]),a=g(),r=Ie({current:1,pageSize:50,total:0,showSizeChanger:!0,showQuickJumper:!0,showTotal:(o,e)=>`第 ${e[0]}-${e[1]} 条，共 ${o} 条`,pageSizeOptions:["50","100","200","500"],onChange:(o,e)=>{r.current=o,r.pageSize=e},onShowSizeChange:(o,e)=>{r.current=1,r.pageSize=e}}),C=[{title:"方法",dataIndex:"req_method",key:"req_method",width:80},{title:"请求路径",dataIndex:"req_url",key:"req_url",ellipsis:!0},{title:"状态码",dataIndex:"resp_status_code",key:"resp_status_code",width:100,sorter:(o,e)=>(Number.parseInt(o.resp_status_code)||0)-(Number.parseInt(e.resp_status_code)||0)},{title:"IP地址",dataIndex:"ip",key:"ip",width:120},{title:"延迟",dataIndex:"latency",key:"latency",width:100,customRender:({text:o})=>ze(o)},{title:"开始时间",dataIndex:"start_time",key:"start_time",width:150,customRender:({text:o})=>Be(o),sorter:(o,e)=>o.start_time-e.start_time},{title:"操作",key:"action",width:100}],k=B(()=>(w.value?.data||[]).filter(e=>{const D=!p.value||e.req_url?.toLowerCase().includes(p.value.toLowerCase())||e.ip?.includes(p.value)||e.request_id?.includes(p.value),P=!m.value||e.req_method===m.value,y=!S.value||String(e.resp_status_code)===S.value;return D&&P&&y}));ee(w,o=>{r.total=o?.total||0},{immediate:!0});const N=B(()=>({selectedRowKeys:i.value,onChange:o=>{i.value=o},getCheckboxProps:o=>({disabled:!1,name:o.request_id})})),$=B(()=>(k.value||[]).filter(e=>i.value.includes(e.request_id)));async function O(o){const{data:e,execute:D}=j(o.request_id);await D(),E.value=e.value||o,A.value=!0}function R(){A.value=!1,E.value=void 0}async function U(){await x(),i.value=[]}async function H(){if(!($.value.length===0||!a.value))try{const o=K.loading("正在获取详细日志数据...",0),e=$.value.map(async y=>{const{data:f,execute:z}=j(y.request_id);return await z(),f.value||y}),P=(await Promise.all(e)).filter(y=>y.session_logs&&y.session_logs.trim()!==""&&y.session_logs!=="[]");if(o(),P.length===0){K.warning("选中的记录中没有可用的会话日志");return}a.value.open(P)}catch(o){console.error("获取批量日志数据失败:",o),K.error("获取日志数据失败，请重试")}}function V(){i.value=[]}function F(){const o=k.value||[];i.value=o.map(e=>e.request_id)}Le(()=>{x()});const u=setInterval(()=>{G.isConnected||U()},3e4);return $e(()=>{clearInterval(u)}),(o,e)=>{const D=X,P=ge,y=we,f=he,z=ke,M=Te,ae=xe,oe=Q,W=Y,le=Ce,ne=Ae,ue=ye;return _(),L("div",et,[v("div",tt,[t(P,{level:2,class:"mb-4"},{default:s(()=>[t(D,null,{default:s(()=>[t(l(J)),e[5]||(e[5]=v("span",null,"请求监控",-1))]),_:1})]),_:1}),t(Me,null,{default:s(()=>[t(y,{value:l(p),"onUpdate:value":e[0]||(e[0]=d=>T(p)?p.value=d:null),placeholder:"搜索请求路径、IP或ID",style:{width:"250px"},"allow-clear":""},{prefix:s(()=>[t(l(qe))]),_:1},8,["value"]),t(z,{value:l(m),"onUpdate:value":e[1]||(e[1]=d=>T(m)?m.value=d:null),placeholder:"筛选方法",style:{width:"120px"},"allow-clear":""},{default:s(()=>[t(f,{value:"GET"},{default:s(()=>[...e[6]||(e[6]=[n(" GET ",-1)])]),_:1}),t(f,{value:"POST"},{default:s(()=>[...e[7]||(e[7]=[n(" POST ",-1)])]),_:1}),t(f,{value:"PUT"},{default:s(()=>[...e[8]||(e[8]=[n(" PUT ",-1)])]),_:1}),t(f,{value:"DELETE"},{default:s(()=>[...e[9]||(e[9]=[n(" DELETE ",-1)])]),_:1}),t(f,{value:"PATCH"},{default:s(()=>[...e[10]||(e[10]=[n(" PATCH ",-1)])]),_:1})]),_:1},8,["value"]),t(z,{value:l(S),"onUpdate:value":e[2]||(e[2]=d=>T(S)?S.value=d:null),placeholder:"筛选状态码",style:{width:"150px"},"allow-clear":""},{default:s(()=>[t(f,{value:"200"},{default:s(()=>[...e[11]||(e[11]=[n(" 200 - 成功 ",-1)])]),_:1}),t(f,{value:"400"},{default:s(()=>[...e[12]||(e[12]=[n(" 400 - 错误请求 ",-1)])]),_:1}),t(f,{value:"401"},{default:s(()=>[...e[13]||(e[13]=[n(" 401 - 未授权 ",-1)])]),_:1}),t(f,{value:"404"},{default:s(()=>[...e[14]||(e[14]=[n(" 404 - 未找到 ",-1)])]),_:1}),t(f,{value:"500"},{default:s(()=>[...e[15]||(e[15]=[n(" 500 - 服务器错误 ",-1)])]),_:1})]),_:1},8,["value"]),t(M,{type:"primary",loading:l(b),onClick:U},{icon:s(()=>[t(l(be))]),default:s(()=>[e[16]||(e[16]=n(" 刷新数据 ",-1))]),_:1},8,["loading"]),t(ae,{type:"vertical"}),t(M,{onClick:F},{default:s(()=>[...e[17]||(e[17]=[n(" 全选 ",-1)])]),_:1}),t(M,{disabled:l(i).length===0,onClick:V},{default:s(()=>[...e[18]||(e[18]=[n(" 清除选择 ",-1)])]),_:1},8,["disabled"]),t(M,{type:"primary",disabled:l($).length===0,onClick:H},{icon:s(()=>[t(l(Se))]),default:s(()=>[n(" 批量查看日志 ("+c(l($).length)+") ",1)]),_:1},8,["disabled"])]),_:1}),l(i).length>0?(_(),L("div",st,[t(oe,{message:`已选择 ${l(i).length} 条记录，点击批量查看日志时会自动获取详细信息并过滤有日志的记录`,type:"info","show-icon":""},null,8,["message"])])):h("",!0)]),t(ue,null,{default:s(()=>[t(ne,{pagination:l(r),"onUpdate:pagination":e[3]||(e[3]=d=>T(r)?r.value=d:null),columns:C,"data-source":l(k),loading:l(b),scroll:{x:900},"row-selection":l(N),"row-key":"request_id",size:"small"},{bodyCell:s(({column:d,record:q})=>[d.key==="req_method"?(_(),I(W,{key:0,color:"blue",class:"font-mono text-xs"},{default:s(()=>[n(c(l(Ge)(q.req_method)),1)]),_:2},1024)):h("",!0),d.key==="req_url"?(_(),I(le,{key:1,title:q.req_url},{default:s(()=>[v("span",at,c(q.req_url),1)]),_:2},1032,["title"])):h("",!0),d.key==="resp_status_code"?(_(),I(W,{key:2,class:Pe(l(Ne)(parseInt(q.resp_status_code)||q.status))},{default:s(()=>[n(c(q.resp_status_code||q.status),1)]),_:2},1032,["class"])):h("",!0),d.key==="ip"?(_(),L("span",ot,c(q.ip),1)):h("",!0),d.key==="action"?(_(),I(D,{key:4},{default:s(()=>[t(M,{type:"link",size:"small",onClick:ut=>O(q)},{default:s(()=>[...e[19]||(e[19]=[n(" 查看 ",-1)])]),_:1},8,["onClick"])]),_:2},1024)):h("",!0)]),emptyText:s(()=>[v("div",lt,[t(l(J),{class:"text-4xl text-gray-300 mb-2"}),e[20]||(e[20]=v("p",{class:"text-gray-500"}," 暂无请求数据 ",-1))])]),_:1},8,["pagination","data-source","loading","row-selection"])]),_:1}),t(Oe,{visible:l(A),"onUpdate:visible":e[4]||(e[4]=d=>T(A)?A.value=d:null),request:l(E),onClose:R},null,8,["visible","request"]),t(Ze,{ref_key:"batchLogsModalRef",ref:a},null,512)])}}}),ft=te(nt,[["__scopeId","data-v-99a286fa"]]);export{ft as default};
